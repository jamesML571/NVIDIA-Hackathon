<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Design Auditor - NVIDIA AI</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --blue-500: #3b82f6;
            --purple-500: #a855f7;
            --pink-500: #ec4899;
            --green-500: #10b981;
            --orange-500: #f97316;
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .critical { border-left: 4px solid #dc2626; background: #fef2f2; }
        .major { border-left: 4px solid #ea580c; background: #fff7ed; }
        .minor { border-left: 4px solid #2563eb; background: #eff6ff; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-wcag { background: #dbeafe; color: #1e40af; }
        .badge-psych { background: #fce7f3; color: #9f1239; }
        .badge-perf { background: #d1fae5; color: #065f46; }
        .badge-seo { background: #fef3c7; color: #92400e; }
        .badge-general { background: #e5e7eb; color: #374151; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const API = 'http://localhost:8000';

        function App() {
            const [mode, setMode] = useState('url'); // 'url' or 'screenshot'
            const [url, setUrl] = useState('');
            const [screenshots, setScreenshots] = useState([]);
            const [loading, setLoading] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState('');
            const [chatMsg, setChatMsg] = useState('');
            const [chatHistory, setChatHistory] = useState([]);
            const [chatLoading, setChatLoading] = useState(false);
            const [dragActive, setDragActive] = useState(false);

            const handleScreenshots = (files) => {
                const imageFiles = Array.from(files).filter(f => f.type.startsWith('image/')).slice(0, 3);
                if (imageFiles.length > 0) {
                    setScreenshots(imageFiles);
                    setError('');
                } else {
                    setError('Please select valid image files (max 3)');
                }
            };

            const handleFileInput = (e) => {
                handleScreenshots(e.target.files);
            };

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleScreenshots(e.dataTransfer.files);
                }
            };

            const removeScreenshot = (idx) => {
                setScreenshots(prev => prev.filter((_, i) => i !== idx));
            };

            const runAudit = async () => {
                setLoading(true);
                setError('');
                setResults(null);

                try {
                    const formData = new FormData();

                    if (mode === 'url') {
                        if (!url) throw new Error('Enter a URL');

                        // Fetch HTML with CORS handling
                        try {
                            const htmlResp = await fetch(url, { mode: 'cors' });
                            if (!htmlResp.ok) throw new Error(`Cannot fetch URL: ${htmlResp.status}`);
                            const html = await htmlResp.text();

                            formData.append('url', url);
                            formData.append('html_content', html);
                        } catch (fetchErr) {
                            throw new Error(`CORS error - cannot fetch HTML from ${url}. Try using screenshots instead.`);
                        }
                    } else {
                        if (screenshots.length === 0) throw new Error('Upload at least one screenshot');
                        screenshots.forEach(img => {
                            formData.append('screenshots', img);
                        });
                    }

                    const resp = await fetch(`${API}/api/audit`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        const errorText = await resp.text();
                        throw new Error(`Server error (${resp.status}): ${errorText}`);
                    }

                    const data = await resp.json();
                    console.log('Audit results:', data);
                    setResults(data);
                } catch (err) {
                    console.error('Audit error:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const sendChat = async () => {
                if (!chatMsg.trim()) return;

                setChatLoading(true);
                const userMsg = chatMsg;
                setChatMsg('');

                // Add user message
                setChatHistory(prev => [...prev, { role: 'user', content: userMsg }]);

                try {
                    const resp = await fetch(`${API}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: userMsg,
                            context: results // Pass audit for context
                        })
                    });

                    const data = await resp.json();
                    setChatHistory(prev => [...prev, { role: 'assistant', content: data.answer }]);
                } catch (err) {
                    setChatHistory(prev => [...prev, { role: 'assistant', content: 'Error: ' + err.message }]);
                } finally {
                    setChatLoading(false);
                }
            };

            const getCategoryBadge = (cat) => {
                const map = {
                    'WCAG Accessibility': 'badge-wcag',
                    'Psychological/UX': 'badge-psych',
                    'Performance': 'badge-perf',
                    'SEO/Discoverability': 'badge-seo',
                    'General Improvement': 'badge-general'
                };
                return `badge ${map[cat] || 'badge-general'}`;
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="gradient-bg text-white py-8 px-6 shadow-lg">
                        <div className="max-w-6xl mx-auto">
                            <h1 className="text-4xl font-bold mb-2">üîç Professional Web Design + Accessibility Auditor</h1>
                            <p className="text-xl opacity-90">Attach ‚Ä¢ Audit ‚Ä¢ Adjust</p>
                            <p className="text-sm mt-2 opacity-90">Created for World's Shortest Hackathon - Powered by NVIDIA</p>
                        </div>
                    </header>

                    <div className="max-w-6xl mx-auto p-6">
                        {/* Input Section */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex gap-4 mb-6 border-b pb-2">
                                <button
                                    onClick={() => setMode('url')}
                                    className={`px-4 py-2 font-semibold transition ${mode === 'url' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500'}`}
                                >
                                    üîó Website URL
                                </button>
                                <button
                                    onClick={() => setMode('screenshot')}
                                    className={`px-4 py-2 font-semibold transition ${mode === 'screenshot' ? 'text-purple-600 border-b-2 border-purple-600' : 'text-gray-500'}`}
                                >
                                    üì∏ Screenshot
                                </button>
                            </div>

                            {mode === 'url' ? (
                                <div>
                                    <label className="block font-semibold text-gray-700 mb-2">Enter Website URL</label>
                                    <input
                                        type="url"
                                        value={url}
                                        onChange={(e) => setUrl(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && runAudit()}
                                        placeholder="https://example.com"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    />
                                </div>
                            ) : (
                                <div>
                                    <label className="block font-semibold text-gray-700 mb-2">Upload Screenshots (1-3 images)</label>
                                    <div
                                        className={`border-2 border-dashed rounded-lg p-6 text-center transition ${dragActive ? 'border-purple-500 bg-purple-50' : 'border-gray-300'}`}
                                        onDragEnter={handleDrag}
                                        onDragLeave={handleDrag}
                                        onDragOver={handleDrag}
                                        onDrop={handleDrop}
                                    >
                                        <input
                                            type="file"
                                            accept="image/*"
                                            multiple
                                            onChange={handleFileInput}
                                            className="hidden"
                                            id="screenshot-input"
                                        />
                                        <label htmlFor="screenshot-input" className="cursor-pointer">
                                            <div className="text-gray-600">
                                                <p className="text-lg font-semibold mb-2">üì∏ Drag & drop images here</p>
                                                <p className="text-sm">or click to browse</p>
                                                <p className="text-xs mt-2 text-gray-500">Max 3 screenshots</p>
                                            </div>
                                        </label>
                                    </div>
                                    {screenshots.length > 0 && (
                                        <div className="mt-4 grid grid-cols-3 gap-3">
                                            {screenshots.map((img, idx) => (
                                                <div key={idx} className="relative border rounded-lg p-2 bg-gray-50">
                                                    <img src={URL.createObjectURL(img)} alt={`Preview ${idx + 1}`} className="w-full h-24 object-cover rounded" />
                                                    <button
                                                        onClick={() => removeScreenshot(idx)}
                                                        className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600"
                                                    >
                                                        ‚úï
                                                    </button>
                                                    <p className="text-xs text-gray-600 mt-1 truncate">{img.name}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            <button
                                onClick={runAudit}
                                disabled={loading}
                                className="mt-4 w-full bg-gradient-to-r from-purple-600 to-purple-800 text-white font-bold py-3 px-6 rounded-lg hover:shadow-lg transition disabled:opacity-50"
                            >
                                {loading ? 'Analyzing...' : 'üöÄ Run Accessibility Audit'}
                            </button>

                            {error && <div className="mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">{error}</div>}
                        </div>

                        {/* Loading */}
                        {loading && (
                            <div className="flex justify-center items-center py-12">
                                <div className="spinner"></div>
                                <p className="ml-4 text-gray-600">Analyzing with NVIDIA AI models...</p>
                            </div>
                        )}

                        {/* Results */}
                        {results && (
                            <>
                                {/* Score Card */}
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <h2 className="text-3xl font-bold text-gray-800">Overall Design Score</h2>
                                            <p className="text-gray-600">{results.summary}</p>
                                        </div>
                                        <div className="text-center">
                                            <div className={`text-6xl font-bold ${results.score >= 70 ? 'text-green-600' : results.score >= 50 ? 'text-yellow-600' : 'text-red-600'}`}>
                                                {results.score}
                                            </div>
                                            <div className="text-2xl font-semibold text-gray-600">Grade: {results.grade}</div>
                                        </div>
                                    </div>
                                    <div className="text-sm text-gray-500 mb-4">
                                        Analysis: {results.analysis_type} ‚Ä¢ {new Date(results.timestamp).toLocaleString()}
                                    </div>

                                    {/* Warnings */}
                                    {results.warnings && results.warnings.length > 0 && (
                                        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                            <p className="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Analysis Limitations:</p>
                                            {results.warnings.map((warning, idx) => (
                                                <p key={idx} className="text-sm text-yellow-700">‚Ä¢ {warning}</p>
                                            ))}
                                        </div>
                                    )}

                                    {/* Category Scores */}
                                    {results.category_scores && (
                                        <div className="mt-6">
                                            <h3 className="text-xl font-bold text-gray-800 mb-4">Category Breakdown</h3>
                                            <div className="grid grid-cols-5 gap-4">
                                                {Object.entries({
                                                    wcag: { label: 'WCAG', color: 'blue' },
                                                    ux_psychology: { label: 'UX Psychology', color: 'purple' },
                                                    visual_design: { label: 'Visual Design', color: 'pink' },
                                                    seo: { label: 'SEO', color: 'green' },
                                                    performance: { label: 'Performance', color: 'orange' }
                                                }).map(([key, info]) => {
                                                    const score = results.category_scores[key] || 0;
                                                    const percentage = (score / 100) * 360;
                                                    const isUnavailable = score === 0 && results.warnings && results.warnings.length > 0;
                                                    return (
                                                        <div key={key} className="text-center">
                                                            <div className="relative w-24 h-24 mx-auto mb-2">
                                                                <svg className="transform -rotate-90 w-24 h-24">
                                                                    <circle cx="48" cy="48" r="40" stroke="#e5e7eb" strokeWidth="8" fill="none" />
                                                                    <circle
                                                                        cx="48"
                                                                        cy="48"
                                                                        r="40"
                                                                        stroke={isUnavailable ? '#d1d5db' : `var(--${info.color}-500)`}
                                                                        strokeWidth="8"
                                                                        fill="none"
                                                                        strokeDasharray={`${percentage * 0.7} 251.2`}
                                                                        strokeLinecap="round"
                                                                    />
                                                                </svg>
                                                                <div className="absolute inset-0 flex items-center justify-center">
                                                                    <span className={`text-xl font-bold ${isUnavailable ? 'text-gray-400' : 'text-gray-700'}`}>
                                                                        {isUnavailable ? 'N/A' : score}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <p className="text-sm font-semibold text-gray-700">{info.label}</p>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Issues */}
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                        Issues Found ({results.issues.length})
                                    </h2>

                                    {results.issues.map((issue, idx) => (
                                        <div key={idx} className={`mb-4 p-4 rounded-lg ${issue.severity === 'Critical' ? 'critical' : issue.severity === 'Major' ? 'major' : 'minor'}`}>
                                            <div className="flex items-start justify-between mb-2">
                                                <h3 className="text-lg font-bold text-gray-800">{issue.title}</h3>
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${issue.severity === 'Critical' ? 'bg-red-600 text-white' : issue.severity === 'Major' ? 'bg-orange-600 text-white' : 'bg-blue-600 text-white'}`}>
                                                    {issue.severity}
                                                </span>
                                            </div>

                                            <div className="mb-2 flex flex-wrap gap-2">
                                                {issue.categories.map((cat, i) => (
                                                    <span key={i} className={getCategoryBadge(cat)}>{cat}</span>
                                                ))}
                                            </div>

                                            <p className="text-gray-700 mb-2"><strong>Description:</strong> {issue.description}</p>
                                            <p className="text-gray-700 mb-2"><strong>Impact:</strong> {issue.impact}</p>
                                            <p className="text-gray-700 mb-2"><strong>Solution:</strong> {issue.solution}</p>
                                            {issue.wcag_reference && (
                                                <p className="text-sm text-gray-600 italic">üìò {issue.wcag_reference}</p>
                                            )}
                                        </div>
                                    ))}
                                </div>

                                {/* Who This Helps */}
                                <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-lg p-6 mb-6 border border-purple-200">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">üë• Who These Changes Help</h2>
                                    {Object.entries(results.who_this_helps).map(([group, desc], idx) => (
                                        <div key={idx} className="mb-4 last:mb-0">
                                            <h3 className="text-lg font-semibold text-purple-800 mb-2">{group}</h3>
                                            <p className="text-gray-700">{desc}</p>
                                        </div>
                                    ))}
                                </div>

                                {/* Chat */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">üí¨ Follow-up Questions?</h2>
                                    <p className="text-gray-600 mb-4">Ask about WCAG guidelines, implementation details, or compliance requirements.</p>

                                    <div className="space-y-3 mb-4 max-h-64 overflow-y-auto">
                                        {chatHistory.map((msg, idx) => (
                                            <div key={idx} className={`p-3 rounded-lg ${msg.role === 'user' ? 'bg-purple-100 ml-8' : 'bg-gray-100 mr-8'}`}>
                                                <div className="font-semibold text-sm text-gray-600 mb-1">
                                                    {msg.role === 'user' ? 'You' : 'ü§ñ AI Assistant'}
                                                </div>
                                                <div className="text-gray-800">{msg.content}</div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={chatMsg}
                                            onChange={(e) => setChatMsg(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && sendChat()}
                                            placeholder="Ask a question about the audit..."
                                            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                            disabled={chatLoading}
                                        />
                                        <button
                                            onClick={sendChat}
                                            disabled={chatLoading}
                                            className="px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 disabled:opacity-50"
                                        >
                                            {chatLoading ? '...' : 'Send'}
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
